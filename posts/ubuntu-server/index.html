<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tips for an Ubuntu Server | Rover</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.68.3" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Winston Tsia">
<meta name="keywords" content="Ubuntu">
<meta name="description" content="Description">
<link rel="stylesheet" type="text/css" media="screen" href="/rover/css/normalize.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/rover/css/main.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/rover/css/all.css" /><link rel="stylesheet" href="/rover/css/katex.css" crossorigin="anonymous">
<script defer src="/rover/js/katex.js"  integrity="sha384-PFWG8XW41D5NzhNv5FegM1CUkw9nNLdWug8DuwnUoNEVop9n5frjcnbtsZtxTNjw" crossorigin="anonymous"></script>
<script defer src="/rover/js/auto-render.js" integrity="sha384-EN2q+JG5/3Z8gD7hT5WZqq+W+9wQR4P3IezfuZmGG5RkNXaaaks85seDJO7WkZlY" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script>
document.addEventListener("DOMContentLoaded", function() { renderMathInElement(document.body, { delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false} ] }); });
</script>
<script






src="/rover/">
</script>




<meta property="og:title" content="Tips for an Ubuntu Server" />
<meta property="og:description" content="Description" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wtsia.github.io/rover/posts/ubuntu-server/" />
<meta property="article:published_time" content="2022-09-26T21:24:43-07:00" />
<meta property="article:modified_time" content="2022-09-26T21:24:43-07:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tips for an Ubuntu Server"/>
<meta name="twitter:description" content="Description"/>

<meta itemprop="name" content="Tips for an Ubuntu Server">
<meta itemprop="description" content="Description">
<meta itemprop="datePublished" content="2022-09-26T21:24:43-07:00" />
<meta itemprop="dateModified" content="2022-09-26T21:24:43-07:00" />
<meta itemprop="wordCount" content="1541">



<meta itemprop="keywords" content="Ubuntu," />
</head>
<body>
<header>
<div id="avatar">
<a href="https://wtsia.github.io/rover/"><img src="/rover/img/about.jpg" alt="Rover"></a>
</div>
<div id="titletext">
<h2 id="title"><a href="https://wtsia.github.io/rover/">Rover</a></h2>
</div>
<div id="title-description">
<p id="subtitle"><a href="https://wtsia.github.io/rover/">Rover</a> is a blog for teaching or storing concepts.</p>
<div id="social">
<nav><ul>
<li><a href="https://github.com/wtsia"><i title="Github" class="icons fab fa-github"></i></a></li>
<li><a href="/rover/index.xml"><i title="RSS" class="icons fas fa-rss"></i></a></li>
<li><a><i title="Switch Dark Mode" class="dark-mode icons fas fa-moon"></i></a></li>
</ul></nav>
</div>
</div>
<div id="mainmenu">
<nav>
<ul>
<li><a href="/rover/">Home</a></li>
<li><a href="/rover/posts">All Posts</a></li>
<li><a href="/rover/about">About</a></li>
<li><a href="/rover/tags">Tags</a></li>
<li><a href="/rover/categories">Categories</a></li>
<li><a href="/rover/files">Files</a></li>
</ul>
</nav>
</div>
</header>
<main>
<div class="post">
<article>
<div class="post-header">
<div class="meta">
</div>
<div class="matter">
<h1 class="title">Tips for an Ubuntu Server</h1>
<p class="post-meta">
<span class="post-meta">



</span>

</p>
</div>
</div>
<div class="markdown">
<h2 id="useful-server-commands">Useful server commands</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">//useful for monitoring changes to a `.log` file in real time.
watch -n 1 tail /var/log/&lt;webserver&gt;/&lt;something&gt;.log

// query icanhazip.com for your ip address
curl -4 icanhazip.com

// show ubuntu firewall status&#39; numbered
sudo ufw status numbered

// delete &#39;n&#39; rule
sudo ufw delete &#39;n&#39;

// mounting drives
sudo lsblk
sudo fdisk -l           // list drives
sudo blkid              // get uuid of drive
sudo nano /etc/fstab    // edit fstab using nano
# example of a disk mount
/dev/disk/by-uuid/6cb3542a-02ab-4df6-8bce-4c193a2f839b  /&lt;directory for mount&gt;  &lt;storage type like ext4&gt;    defaults    0   0    
sudo mount -a

// show video card drivers
lshw -c video

// traceroute
traceroute -m &lt;max num hops&gt; -p &lt;port&gt; &lt;site&gt;

// unlocking Luks Drive
sudo cryptsetup open /dev/sdd3 luksrecoverytarget  --type luks

// view formatted systemctl logs
journalctl -u &lt;service&gt; --no-pager | less

// rsync
rsync -rtvu source_folder/ destination_folder/
// -v verbose
// -t 
// -u 
// -r recursive

//ubuntu drivers
sudo ubuntu-drivers devices

// make filename.sh executable
chmod +x filename.sh

</code></pre></div><h3 id="ubuntu-server-troubleshooting">Ubuntu Server Troubleshooting</h3>
<ul>
<li>allocated space not totally filled (seen after <code>lsblk</code>)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// ubuntu stack overflow
I also used the default Ubuntu 20.04 install from ISO w/ lvm option selected. I had the same problem with the OS disk not occupying what I had allocated. Eddie&#39;s suggestion and the provided link did it for me. To summarize:

root@util:~# vgdisplay
&lt;snip&gt;
root@util:~# lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv
&lt;snip&gt;
root@util:~# resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
&lt;snip&gt;
</code></pre></div><h2 id="useful-text-editor-shortcuts">useful text editor shortcuts</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// NANO
Ctrl + 6 to set a mark.
Alt + T will delete all content in a file.
Ctrl + K will delete the current line at your cursor.
</code></pre></div><h1 id="setting-up-reverse-proxy-with-caddy-or-nginx">Setting up Reverse Proxy with Caddy or Nginx</h1>
<p>To create a web server that is accessible from a domain, we will be using Caddy or Nginx proxy manager to set up our local reverse proxy and manage Nginx from a friendly UI.</p>
<h2 id="caddy">Caddy</h2>
<p><a href="https://caddyserver.com/docs/install" target="_blank">Caddy Installation Documentation</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https

curl -1sLf &#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39; | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg

curl -1sLf &#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39; | sudo tee /etc/apt/sources.list.d/caddy-stable.list

sudo apt update
sudo apt install caddy

sudo systemctl start caddy

// edit caddy file
sudo nano /etc/caddy/Caddyfile

site:port {
    reverse_proxy address:internal_port
}

sudo systemctl reload caddy

</code></pre></div><h1 id="docker">Docker</h1>
<h2 id="installation">Installation</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// update list. If your output seems abnormal, take a moment to think on your next step. This is a guide that worked for me on Ubuntu 22.04.1 LTS
sudo apt update

// install prerequisites:
sudo apt install apt-transport-https ca-certificates curl software-properties-common

// add a GPG key for the official Docker repo:
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

// Add docker repo to APT sources:
echo &#34;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&#34; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null

// update existing list of packages
sudo apt update

// check you are installing from the Docker repo
apt-cache policy docker-ce

// install docker, docker container, containerd, cli and plugins
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

// check docker is installed
sudo systemctl status docker

// adding yourself as part of the docker group
sudo usermod -aG docker ${USER}

//log out and log back in or:
su - ${USER}
</code></pre></div><h2 id="docker-portainer">Docker: Portainer</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">docker run -d --restart always -p 8000:8000 -p 9443:9443 -v /var/run/docker.sock:/var/run/docker.sock --name portainer portainer/portainer-ce
</code></pre></div><h3 id="docker-commandsoperations">Docker Commands/Operations</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// run docker container from docker-compose.yml in (-d) background
docker-compose up -d 

// list docker images
docker image ls 

// restart all containers
docker restart $(docker ps -q) 

// remove all containers
docker rm $(docker ps -aq) 

// run shell in docker
$ docker exec -it &lt;container id&gt; &lt;bash or sh&gt; 
root@&lt;container id&gt;:/#
// or as root:

// show logs output in docker container
docker logs &lt;container-id&gt;

// 
</code></pre></div><h2 id="docker-nginx-proxy-manager">Docker: Nginx Proxy Manager</h2>
<p>Quick-Start (9.28.2022)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"># use this as a docker-compose.yml file
version: &#39;3&#39;
services:
  app:
    image: &#39;jc21/nginx-proxy-manager:latest&#39;
    restart: unless-stopped
    ports:
      - &#39;80:80&#39;
      - &#39;81:81&#39;
      - &#39;443:443&#39;
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
</code></pre></div><p>Then initiate your stack: `docker-compose up -d&rsquo;</p>
<h1 id="nginx">Nginx</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// enable autostart
sudo update-rc.d nginx defaults

// disable nginx from autostarting
sudo update-rc.d -f nginx disable
</code></pre></div><h2 id="port-forwarding">Port Forwarding</h2>
<ul>
<li>TCP/UDP: Connecting and holding to an endpoint/Sending a signal and hoping it arrives</li>
<li>dealing with busy port:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">sudo netstat -nlptu | grep 80
sudo systemctl stop nginx
sudo systemctl stop apache
</code></pre></div><h1 id="server-security">Server Security</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">sudo ufw enable // make sure to enable the server firewall. 

sudo ufw reload // reload server firewall rules

sudo apt install unattended-upgrades // automatically install security updates

// using ssh keys to access your server (mostly for convenience)
// at local:
ssh-keygen -t ed25519

ssh-copy-id -i /&lt;key directory&gt; &lt;user&gt;@&lt;ip&gt;
(default: /home/&lt;user&gt;/.ssh/id_ed25519.pub)
// edit ssh settings on server
sudo nano /etc/ssh/sshd_config
systemctl restart sshd          // restart daemon

// create easier login @ .bashrc
sudo nano ~/.bashrc
// add &#34;alias &lt;name&gt;=&#34;ssh -p &lt;port&gt; &lt;user&gt;@&lt;ip address&gt;&#34;
source ~/.bashrc
</code></pre></div><h2 id="fail2ban">Fail2ban</h2>
<ul>
<li></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// fail2ban SSH logins
sudo apt install fail2ban

// create sshd ban entry-- cp fail2ban.conf and enter at the bottom of /etc/fail2ban/fail2ban.local
[sshd]
enabled = true
port = &lt;port&gt;
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = -1

sudo service fail2ban restart // restart fail2ban

sudo fail2ban-client status

// to unban:
sudo fail2ban-client set sshd unbanip &lt;ip&gt;

// 2FA SSH w/ Google Authenticator
sudo apt install libpam-google-authenticator

sudo nano /etc/pam.d/sshd

sudo nano /etc/ssh/sshd_config

// edit sshd config, then restart
sudo service sshd restart

// to reverse, remove entries from files

// chkrootkit
git clone https://github.com/Magentron/chkrootkit.git   // clone from repo
cd chkrootkit                                           // cd into directory
./chkrootkit                                            // run chkrootkit

// rkhunter
wget http://downloads.sourceforge.net/project/rkhunter/rkhunter/1.4.6/rkhunter-1.4.6.tar.gz             // download package
tar -xvf rkhunter-1.4.6.tar.gz  // extract
rkhunter --check                // run tool
</code></pre></div><h2 id="maldet-linux-malware-detection">Maldet: Linux Malware Detection</h2>
<h3 id="installation-1">Installation</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// cd into a directory to unpack maldet files
wget https://www.rfxn.com/downloads/maldetect-current.tar.gz
tar -xvf maldetect-current.tar.gz
cd maldet-&lt;version&gt;
./install.sh

// update maldet
maldet -u

// edit maldet config
nano /usr/local/maldetect/conf.maldet
</code></pre></div><p>Make sure to have <code>clamav</code> installed so that maldet can utilize the clamav binary for the scanner engine.</p>
<p><code>maldet --scan-all &lt;directory&gt;</code>: scan the entirety of a directory and subdirectories</p>
<p><code>maldet -u</code>: update maldet</p>
<h1 id="media">Media</h1>
<h3 id="installing-jellyfin-docker">Installing Jellyfin (Docker)</h3>
<p><a href="https://jellyfin.org/docs/general/administration/installing.html">https://jellyfin.org/docs/general/administration/installing.html</a></p>
<h3 id="transcoding">Transcoding</h3>
<p>To properly change track order of an <code>.mkv</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">mkvmerge --output &#34;your_file (1).mkv&#34; &#34;(&#34; &#34;your_file.mkv&#34; &#34;)&#34; --track-order 0:0,0:2,0:1

# first, get audio track info so we know which one to keep
mkvmerge -i input.mkv
File &#39;input.mkv&#39;: container: Matroska
Track ID 1: video (V_MPEG4/ISO/AVC)
Track ID 2: audio (A_AAC)
Track ID 3: audio (A_AAC)        &lt;----------- for example, let&#39;s keep this one
Track ID 4: audio (A_AAC)

mkvmerge -o output.mkv --audio-tracks 3 input.mkv
</code></pre></div><h3 id="converting-mkv-to-h264-with-ffmpeg">Converting mkv to h264 with FFmpeg</h3>
<p>EDIT: This question has become very popular and is one of the top results for searching &ldquo;convert mkv to h264 ffmpeg&rdquo; and thus I feel it is appropriate to add that for anyone stumbling upon this question to rather use</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">ffmpeg -i input.mkv -c:v libx264 -c:a aac output.mp4

// 10-bit/12-bit HEVC to 10-bit H.264

ffmpeg -i input -map 0 -c:v libx264 -crf 18 -c:a copy output.mk
</code></pre></div><p><a href="https://stackoverflow.com/questions/30898671/converting-mkv-to-h264-ffmpeg" target="_blank">link</a></p>
<h3 id="hevc-x265-to-mp4-x264">HEVC x265 to MP4 x264</h3>
<p><code>ffmpeg -i input.mp4 -c:v libx264 -crf 20 -c:a copy output.mp4</code></p>
<p>10-bit/12-bit HEVC to 8-bit H.264</p>
<p><code>ffmpeg -i input -map 0 -c:v libx264 -crf 18 -vf format=yuv420p -c:a copy output.mkv</code></p>
<pre><code>-map 0 will include all streams (default stream selection only selects 1 stream per type). See FFmpeg Wiki: Map.

Adjust the -crf value to provide the desired level of quality. Add the -preset option if you want to adjust encoding speed. See FFmpeg Wiki: H.264 for more info on -crf and -preset.

Uses the format filter to choose the yuv420p pixel format to create 8-bit output.
</code></pre>
<p>10-bit/12-bit HEVC to 10-bit H.264</p>
<p><code>ffmpeg -i input -map 0 -c:v libx264 -crf 18 -c:a copy output.mkv</code></p>
<pre><code>-map 0 will include all streams (default stream selection only selects 1 stream per type). See FFmpeg Wiki: Map.

Adjust the -crf value to provide the desired level of quality. Add the -preset option if you want to adjust encoding speed. See FFmpeg Wiki: H.264 for more info on -crf and -preset.

No need for the format filter in this case.
</code></pre>
<p>10-bit/12-bit HEVC to 8-bit HEVC</p>
<p><code>ffmpeg -i input -map 0 -c:v libx265 -crf 20 -vf format=yuv420p -c:a copy output.mkv</code></p>
<pre><code>-map 0 will include all streams (default stream selection only selects 1 stream per type). See FFmpeg Wiki: Map.

Adjust the -crf value to provide the desired level of quality. Add the -preset option if you want to adjust encoding speed. See FFmpeg Wiki: HEVC / H.265 for more info on -crf and -preset.

Uses the format filter to choose the yuv420p pixel format to create 8-bit output.
</code></pre>
<p>12-bit HEVC to 10-bit HEVC</p>
<p><code>ffmpeg -i input -map 0 -c:v libx265 -crf 20 -vf format=yuv420p10le -c:a copy output.mkv</code></p>
<pre><code>-map 0 will include all streams (default stream selection only selects 1 stream per type). See FFmpeg Wiki: Map.

Adjust the -crf value to provide the desired level of quality. Add the -preset option if you want to adjust encoding speed. See FFmpeg Wiki: HEVC / H.265 for more info on -crf and -preset.

Uses the format filter to choose the yuv420p10le pixel format to create 10-bit output. Other 10-bit pixel formats supported by libx265 are yuv422p10le &amp; yuv444p10le, but your player may not like these. See ffmpeg -h encoder=libx265 for additional supported pixel formats.
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"># assume input.mkv has 3 subtitle tracks
# remove subtitle track 2 (copy 1&amp;3) from input.mkv &amp; save to output.mkv
mkvmerge -o output.mkv --subtitle-tracks 1,3 input.mkv

# remove all subtitles (copy none)
mkvmerge -o output.mkv --no-subtitles input.mkv
</code></pre></div>
</div>
<div class="tags">
<div class="taxosfloating_left">
<p>Categories</p>
</div>
<div class="termsfloating_right">
<p>
<a href="/rover/categories/computer-networking/">computer-networking</a>
<a href="/rover/categories/it/">it</a>
</p>
</div>
<div class="clearit"></div>
<div class="tags">
<div class="taxosfloating_left">
<p>Tags</p>
</div>
<div class="termsfloating_right">
<p>
<a href="/rover/tags/ubuntu/">ubuntu</a>
</p>
</div>
<div class="clearit"></div>
</div>
</article>
</div>
</main>
<footer>
© Copyright notice | <a href="https://github.com/dataCobra/hugo-vitae">Vitae</a> theme for <a href="https://gohugo.io">Hugo</a>
</footer><script src="/rover/js/dark-mode.js"></script>

</body>
</html>
